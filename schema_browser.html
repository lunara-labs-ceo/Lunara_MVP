<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lunara - Schema Browser</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-stone: #EAE9E5;
            --border-stone: #BAB8B0;
            --electric-blue: #0033FF;
            --electric-blue-hover: #0022CC;
            --dark-text: #1A1A1A;
            --success-green: #059669;
            --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-stone);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        header {
            background: var(--bg-stone);
            border-bottom: 1px solid var(--border-stone);
            position: sticky;
            top: 0;
            z-index: 50;
            flex-shrink: 0;
        }

        .header-inner {
            display: flex;
            align-items: stretch;
            height: 64px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0 24px;
            border-right: 1px solid var(--border-stone);
            text-decoration: none;
            color: var(--dark-text);
        }

        .logo-icon {
            width: 24px;
            height: 24px;
            background: var(--electric-blue);
        }

        .logo-text {
            font-weight: 700;
            font-size: 18px;
            text-transform: uppercase;
            letter-spacing: -0.02em;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            padding: 0 24px;
            gap: 8px;
            font-size: 14px;
            color: var(--dark-text);
        }

        .breadcrumb a {
            color: var(--dark-text);
            text-decoration: none;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .breadcrumb a:hover {
            opacity: 1;
        }

        .breadcrumb-separator {
            opacity: 0.4;
        }

        .breadcrumb-current {
            font-weight: 500;
        }

        .header-spacer {
            flex: 1;
        }

        /* Layout */
        .layout {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: white;
            border-right: 1px solid var(--border-stone);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-stone);
        }

        .sidebar-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .sidebar-title h2 {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--dark-text);
            opacity: 0.6;
        }

        .count-badge {
            background: rgba(0, 51, 255, 0.1);
            color: var(--electric-blue);
            font-size: 12px;
            font-weight: 600;
            padding: 2px 10px;
            border-radius: 12px;
        }

        .filter-input {
            width: 100%;
            padding: 10px 12px 10px 36px;
            border: 1px solid var(--border-stone);
            border-radius: 8px;
            font-size: 14px;
            background: var(--bg-stone);
            position: relative;
        }

        .filter-input:focus {
            outline: none;
            border-color: var(--electric-blue);
        }

        .filter-wrapper {
            position: relative;
        }

        .filter-wrapper .material-symbols-outlined {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            color: var(--dark-text);
            opacity: 0.4;
        }

        .datasets-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .dataset-item {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border: none;
            background: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
            font-weight: 500;
            color: var(--dark-text);
            opacity: 0.7;
            transition: all 0.2s;
            text-align: left;
        }

        .dataset-item:hover {
            background: var(--bg-stone);
            opacity: 1;
        }

        .dataset-item.active {
            background: rgba(0, 51, 255, 0.08);
            color: var(--electric-blue);
            opacity: 1;
        }

        .dataset-item .material-symbols-outlined {
            font-size: 20px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .content-header {
            padding: 32px 32px 16px;
            flex-shrink: 0;
        }

        .page-title {
            font-size: 28px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: -0.02em;
            margin-bottom: 8px;
        }

        .page-description {
            font-size: 14px;
            color: var(--dark-text);
            opacity: 0.6;
        }

        .toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            margin-top: 24px;
        }

        .search-wrapper {
            position: relative;
            flex: 1;
            max-width: 400px;
        }

        .search-wrapper .material-symbols-outlined {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 20px;
            color: var(--dark-text);
            opacity: 0.4;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px 12px 44px;
            border: 1px solid var(--border-stone);
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--electric-blue);
        }

        .table-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .tables-count {
            font-size: 14px;
            font-weight: 600;
            color: var(--electric-blue);
            background: rgba(0, 51, 255, 0.08);
            padding: 6px 14px;
            border-radius: 16px;
        }

        .action-link {
            font-size: 13px;
            font-weight: 500;
            color: var(--electric-blue);
            background: none;
            border: none;
            cursor: pointer;
            font-family: inherit;
        }

        .action-link:hover {
            text-decoration: underline;
        }

        .action-link.secondary {
            color: var(--dark-text);
            opacity: 0.5;
        }

        .separator {
            color: var(--border-stone);
        }

        /* Table */
        .table-container {
            flex: 1;
            overflow: auto;
            padding: 0 32px 120px;
        }

        .data-table {
            width: 100%;
            background: white;
            border: 1px solid var(--border-stone);
            border-radius: 12px;
            border-collapse: collapse;
            overflow: hidden;
        }

        .data-table thead {
            background: var(--bg-stone);
        }

        .data-table th {
            padding: 14px 16px;
            text-align: left;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--dark-text);
            opacity: 0.6;
            border-bottom: 1px solid var(--border-stone);
        }

        .data-table td {
            padding: 14px 16px;
            font-size: 14px;
            border-bottom: 1px solid rgba(186, 184, 176, 0.3);
        }

        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        .data-table tbody tr:hover {
            background: rgba(0, 51, 255, 0.02);
        }

        .data-table tbody tr.selected {
            background: rgba(0, 51, 255, 0.05);
        }

        .table-checkbox {
            width: 18px;
            height: 18px;
            accent-color: var(--electric-blue);
            cursor: pointer;
        }

        .table-name-cell {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .table-icon {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 51, 255, 0.08);
            color: var(--electric-blue);
        }

        .table-icon.view {
            background: rgba(147, 51, 234, 0.08);
            color: #9333EA;
        }

        .table-icon .material-symbols-outlined {
            font-size: 18px;
        }

        .table-name {
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }

        .type-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            background: var(--bg-stone);
            color: var(--dark-text);
            opacity: 0.7;
        }

        .type-badge.view {
            background: rgba(147, 51, 234, 0.1);
            color: #9333EA;
            opacity: 1;
        }

        .mono {
            font-family: 'Courier New', monospace;
        }

        .muted {
            opacity: 0.5;
        }

        /* Footer */
        .footer-bar {
            position: fixed;
            bottom: 0;
            left: 280px;
            right: 0;
            background: white;
            border-top: 1px solid var(--border-stone);
            padding: 16px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 40;
        }

        .selection-info {
            font-size: 14px;
            color: var(--dark-text);
        }

        .selection-info strong {
            font-weight: 700;
        }

        .footer-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .btn-secondary {
            background: white;
            border: 1px solid var(--border-stone);
            color: var(--dark-text);
        }

        .btn-secondary:hover {
            background: var(--bg-stone);
        }

        .btn-primary {
            background: var(--electric-blue);
            color: white;
        }

        .btn-primary:hover {
            background: var(--electric-blue-hover);
        }

        .btn-primary:disabled {
            background: var(--border-stone);
            color: var(--dark-text);
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn .material-symbols-outlined {
            font-size: 18px;
        }

        /* Empty/Loading states */
        .empty-state {
            padding: 48px;
            text-align: center;
            color: var(--dark-text);
            opacity: 0.5;
        }
    </style>
</head>

<body>
    <header>
        <div class="header-inner">
            <a href="/dashboard.html" class="logo">
                <div class="logo-icon"></div>
                <span class="logo-text">Lunara</span>
            </a>
            <div class="breadcrumb">
                <a href="/dashboard.html">Dashboard</a>
                <span class="breadcrumb-separator">/</span>
                <a id="projectLink" href="#">Data Sources</a>
                <span class="breadcrumb-separator">/</span>
                <span class="breadcrumb-current">Schema Browser</span>
            </div>
            <div class="header-spacer"></div>
        </div>
    </header>

    <div class="layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">
                    <h2>Datasets</h2>
                    <span id="datasets-count" class="count-badge">0</span>
                </div>
                <div class="filter-wrapper">
                    <span class="material-symbols-outlined">search</span>
                    <input id="dataset-filter" type="text" class="filter-input" placeholder="Filter datasets...">
                </div>
            </div>
            <div id="datasets-container" class="datasets-list">
                <div class="empty-state">Loading datasets...</div>
            </div>
        </aside>

        <main class="main-content">
            <div class="content-header">
                <h1 id="current-dataset-name" class="page-title">Select a dataset</h1>
                <p class="page-description">Select tables to include in your semantic layer.</p>
                <div class="toolbar">
                    <div class="search-wrapper">
                        <span class="material-symbols-outlined">search</span>
                        <input id="table-search" type="text" class="search-input" placeholder="Search tables...">
                    </div>
                    <div class="table-actions">
                        <span id="tables-count" class="tables-count">0 tables</span>
                        <button id="select-all-btn" class="action-link">Select All</button>
                        <span class="separator">|</span>
                        <button id="deselect-all-btn" class="action-link secondary">Deselect All</button>
                    </div>
                </div>
            </div>

            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 48px;"></th>
                            <th>Table Name</th>
                            <th style="width: 100px;">Type</th>
                            <th style="width: 100px;">Rows</th>
                            <th style="width: 140px;">Last Modified</th>
                        </tr>
                    </thead>
                    <tbody id="tables-container">
                        <tr>
                            <td colspan="5" class="empty-state">Select a dataset to view tables</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <div class="footer-bar">
        <span id="selection-info" class="selection-info"><strong>0 tables</strong> selected</span>
        <div class="footer-actions">
            <button id="back-btn" class="btn btn-secondary">Back</button>
            <button id="generate-btn" class="btn btn-primary" disabled>
                <span class="material-symbols-outlined">auto_awesome</span>
                Generate Semantic Layer
            </button>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE_URL = '';

        // Get project_id from URL
        const urlParams = new URLSearchParams(window.location.search);
        const projectId = urlParams.get('project_id');

        // Update breadcrumb links
        if (projectId) {
            document.getElementById('projectLink').href = `/data_sources.html?project_id=${projectId}`;
        }

        // State
        let datasets = [];
        let selectedDatasetId = null;
        let tables = [];
        let selectedTables = new Set();

        // DOM Elements
        const datasetsContainer = document.getElementById('datasets-container');
        const datasetsCount = document.getElementById('datasets-count');
        const datasetFilter = document.getElementById('dataset-filter');
        const tablesContainer = document.getElementById('tables-container');
        const tablesCount = document.getElementById('tables-count');
        const tableSearch = document.getElementById('table-search');
        const currentDatasetName = document.getElementById('current-dataset-name');
        const selectAllBtn = document.getElementById('select-all-btn');
        const deselectAllBtn = document.getElementById('deselect-all-btn');
        const selectionInfo = document.getElementById('selection-info');
        const generateBtn = document.getElementById('generate-btn');
        const backBtn = document.getElementById('back-btn');

        // Format number with K/M suffix
        function formatNumber(num) {
            if (!num) return '--';
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        // Format relative time
        function formatRelativeTime(isoString) {
            if (!isoString) return '--';
            const date = new Date(isoString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} min${diffMins > 1 ? 's' : ''} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
        }

        // Load datasets from API
        async function loadDatasets() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/v1/datasets`);
                if (!response.ok) {
                    if (response.status === 400) {
                        let redirectUrl = 'bq_connection.html';
                        if (projectId) redirectUrl += `?project_id=${projectId}`;
                        window.location.href = redirectUrl;
                        return;
                    }
                    throw new Error('Failed to load datasets');
                }
                const data = await response.json();
                datasets = data.datasets;
                datasetsCount.textContent = data.count;
                renderDatasets();

                if (datasets.length > 0) {
                    selectDataset(datasets[0].dataset_id);
                }
            } catch (err) {
                console.error('Error loading datasets:', err);
                datasetsContainer.innerHTML = `
                    <div class="empty-state">Failed to load datasets. Is the backend running?</div>
                `;
            }
        }

        // Render datasets in sidebar
        function renderDatasets(filter = '') {
            const filtered = datasets.filter(d =>
                d.dataset_id.toLowerCase().includes(filter.toLowerCase())
            );

            datasetsContainer.innerHTML = filtered.map(d => `
                <button onclick="selectDataset('${d.dataset_id}')" 
                    class="dataset-item ${selectedDatasetId === d.dataset_id ? 'active' : ''}">
                    <span class="material-symbols-outlined">dataset</span>
                    <span>${d.dataset_id}</span>
                </button>
            `).join('');
        }

        // Select a dataset and load its tables
        async function selectDataset(datasetId) {
            selectedDatasetId = datasetId;
            selectedTables.clear();
            renderDatasets();
            updateSelectionUI();

            currentDatasetName.textContent = datasetId;

            try {
                const response = await fetch(`${API_BASE_URL}/api/v1/datasets/${datasetId}/tables`);
                if (!response.ok) throw new Error('Failed to load tables');

                const data = await response.json();
                tables = data.tables;
                tablesCount.textContent = `${data.count} tables`;
                renderTables();
            } catch (err) {
                console.error('Error loading tables:', err);
                tablesContainer.innerHTML = `
                    <tr><td colspan="5" class="empty-state">Failed to load tables</td></tr>
                `;
            }
        }

        // Render tables in main area
        function renderTables(filter = '') {
            const filtered = tables.filter(t =>
                t.table_id.toLowerCase().includes(filter.toLowerCase())
            );

            tablesContainer.innerHTML = filtered.map(t => {
                const isSelected = selectedTables.has(`${selectedDatasetId}.${t.table_id}`);
                const isView = t.table_type === 'VIEW';

                return `
                    <tr class="${isSelected ? 'selected' : ''}">
                        <td>
                            <input type="checkbox" ${isSelected ? 'checked' : ''} 
                                onchange="toggleTable('${t.table_id}')"
                                class="table-checkbox">
                        </td>
                        <td>
                            <div class="table-name-cell">
                                <div class="table-icon ${isView ? 'view' : ''}">
                                    <span class="material-symbols-outlined">${isView ? 'visibility' : 'table_chart'}</span>
                                </div>
                                <span class="table-name">${t.table_id}</span>
                            </div>
                        </td>
                        <td>
                            <span class="type-badge ${isView ? 'view' : ''}">${t.table_type}</span>
                        </td>
                        <td class="mono muted">${formatNumber(t.row_count)}</td>
                        <td class="muted">${formatRelativeTime(t.last_modified)}</td>
                    </tr>
                `;
            }).join('');
        }

        // Toggle table selection
        function toggleTable(tableId) {
            const fullId = `${selectedDatasetId}.${tableId}`;
            if (selectedTables.has(fullId)) {
                selectedTables.delete(fullId);
            } else {
                selectedTables.add(fullId);
            }
            renderTables(tableSearch.value);
            updateSelectionUI();
        }

        // Select/deselect all tables
        function selectAllTables() {
            tables.forEach(t => selectedTables.add(`${selectedDatasetId}.${t.table_id}`));
            renderTables(tableSearch.value);
            updateSelectionUI();
        }

        function deselectAllTables() {
            tables.forEach(t => selectedTables.delete(`${selectedDatasetId}.${t.table_id}`));
            renderTables(tableSearch.value);
            updateSelectionUI();
        }

        // Update selection UI
        function updateSelectionUI() {
            const count = selectedTables.size;
            selectionInfo.innerHTML = `<strong>${count} table${count !== 1 ? 's' : ''}</strong> selected`;

            generateBtn.disabled = count === 0;
        }

        // Event listeners
        datasetFilter.addEventListener('input', (e) => renderDatasets(e.target.value));
        tableSearch.addEventListener('input', (e) => renderTables(e.target.value));
        selectAllBtn.addEventListener('click', selectAllTables);
        deselectAllBtn.addEventListener('click', deselectAllTables);

        backBtn.addEventListener('click', () => {
            let url = 'bq_connection.html';
            if (projectId) url += `?project_id=${projectId}`;
            window.location.href = url;
        });

        generateBtn.addEventListener('click', () => {
            if (selectedTables.size > 0) {
                localStorage.setItem('lunara_selected_tables', JSON.stringify([...selectedTables]));
                let url = 'semantic_layer_setup.html';
                if (projectId) url += `?project_id=${projectId}`;
                window.location.href = url;
            }
        });

        // Initialize
        loadDatasets();
    </script>
</body>

</html>